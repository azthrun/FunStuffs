module WebRequestHelper
  
  TEXTHEADER = {:headers => {"Content-type" => "text/plain"}}
  JSONHEADER = {:headers => {"Accept" => "application/json;"}}
    
  ETHOSDISTRO = "ethosdistro.com/?json=yes"

  #TODO: Test IDs: b57258, 8d2305
  
  def hasNetwork
    response = Rho::Network.get({:url => "http://www.google.com"}).merge(TEXTHEADER)
    ret = response["status"].eql?("ok") ? true : false
    ret
  end
  
  def downloadRigStatus
    if hasNetwork
      requestUrl = "http://#{Settings.panelId}.#{ETHOSDISTRO}"
      response = Rho::Network.get({:url => requestUrl}).merge(JSONHEADER)
      Rho::Log.info(response.inspect, "RESPONSE ======================")

      if response["status"].eql?("ok")
        # Analyze Data
        if response["body"].empty?
          # Panel ID has no live rig
          Rho::WebView.executeJavascript("replacePage('/app/Settings/setup?error=Panel%20has%20no%20live%20rig');")
        else
          storeRigStatus(response["body"])
          Rho::WebView.executeJavascript("replacePage('/app/Settings/home');")
        end
      else
        # GET Request Error
        
      end
    else
      # No Internet Access
      
    end
  end
  
  def storeRigStatus(data)
    begin
      Rho::Log.info(data.inspect, "DATA==================")
      feed = Rho::JSON.parse(data)
      Rho::Log.info("PARSED", "DATA==================")
      
      # Panel overall data
      overall = feed.reject {|k, v| k.eql?("rigs")}
      Settings.set(Settings::PANELOVERALL, overall.to_json)
      
      # Miner data
      rigs = feed["rigs"]
      Miner.storeMinerStatus(rigs)
    rescue => e
      Rho::Log.info(e.inspect, "EXCEPTION =====================")
      Rho::WebView.executeJavascript("replacePage('/app/Settings/setup?error=Unable%20to%20load%20panel%20data');")
    end
  end
  
end